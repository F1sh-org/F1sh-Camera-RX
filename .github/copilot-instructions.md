# F1sh Camera RX â€” AI agent guide

- Purpose: GTK desktop receiver for F1sh cameras; pulls config via HTTP from TX server and renders H.264 RTP/UDP via GStreamer.
- Build: use Meson (`meson setup builddir [--native-file native-file.ini]`; `meson compile -C builddir`). On Windows, build from MSYS2 UCRT64 with only MSYS2 GTK/GStreamer/curl/jansson/microhttpd; do not mix with official installers. Run `./builddir/f1sh-camera-rx` (ensure DLLs on PATH or co-located).
- App lifecycle: [src/main.c](../src/main.c) sets platform GStreamer env (macOS bundle or Windows co-located plugins/scanner/schemas), inits GTK/GStreamer/cURL, builds `App`, launches UI, then starts local HTTP server on port 8889, and enters `gtk_main()`.
- Global state: `App` struct in [src/f1sh_camera_rx.h](../src/f1sh_camera_rx.h) holds config, widget pointers, GStreamer pipeline/bus watch, cURL handle, and connection flags. Respect existing alloc/free (strings via `g_strdup/g_free`, cURL cleanup in `app_cleanup`).
- Streaming: [src/stream.c](../src/stream.c) builds low-latency pipelines tuned per OS (Apple vtdec_hw, Windows d3d11h264dec+d3d11videosink, else avdec_h264). Optional rotation uses `videoflip`; pipeline restarts when rotation changes. Keep bus watch (`gst_bus_add_watch`) and reset `app->bus_watch_id` on stop.
- Local HTTP server: [src/http_server.c](../src/http_server.c) uses libmicrohttpd on 8889 with POST `/rotate` JSON `{"rotate":0-3}`; validates input, mutates `app->config.rotate`, and if streaming schedules a GTK idle restart. Long-running daemon thread controlled by `g_server.running`.
- HTTP client/TX control: [src/http_client.c](../src/http_client.c) uses shared `app->curl`. `/health` probes TX for `{"status":"healthy"}`; `/config` POST sends RX host/port/resolution/framerate JSON; rotation updates also POST to local 8889. Always `curl_easy_reset` before reuse.
- UI entry/main window: [src/ui_main.c](../src/ui_main.c) builds log view, status labels, buttons (stream opens rotate window), kicks serial scan thread, and shows wireless/serial connection status. Destroy handlers call `app_cleanup` then quit.
- Advanced configuration: gated by login in [src/ui_login.c](../src/ui_login.c) (credentials: admin / steam4vietnam). [src/ui_configuration.c](../src/ui_configuration.c) offers TX/RX IPs, resolution presets (720p/1080p), framerate presets (30/50/60), rotate 0-3, log interactivity toggle, test/connect actions, and stream start/stop. Config sends TX `/config` then local `/rotate` before streaming.
- Rotation dialog: [src/ui_rotate.c](../src/ui_rotate.c) provides radio buttons and live drawing; clicking OK closes and toggles stream (stop/start) via `on_open_stream_clicked`.
- Serial probing: [src/serial_probe.c](../src/serial_probe.c) scans COM ports (Windows) or tty/cu patterns (POSIX), writes probe string `{ "status":1 }\n`, and matches response. Runs in background thread and posts UI label updates via idle.
- Logging: [src/ui_log.c](../src/ui_log.c) buffers early logs until UI exists, wraps text to 120 chars, and posts via `g_idle_add`. `ui_set_log_interactive` toggles event swallowing/cursor for the log view; `app_cleanup` discards buffered logs.
- Patterns/conventions: use GLib allocators and GTK helpers; prefer `g_idle_add` for cross-thread UI updates; keep GTK widgets stored in `App`. When modifying pipeline/rotation, restart pipeline on GTK idle to avoid cross-thread GStreamer state changes.
- Packaging/runtime notes: main sets GST_PLUGIN paths and registry cache per-OS; keep co-located plugins/scanner with the exe on Windows/macOS bundle. Avoid mixing runtimes (see README guidance) to prevent GTK/GStreamer ABI conflicts.
- No automated tests present; manual run/stream verification required. Preserve hard-coded defaults (127.0.0.1 IPs, UDP port 5000, RX HTTP 8889, TX HTTP 8888) unless coordinated with TX counterpart.
